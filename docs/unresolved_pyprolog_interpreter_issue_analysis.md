# pyprolog インタプリタにおける未解決問題に関する考察

## 1. 現象の詳細

- Prolog KB（医療診断システム）は `pyprolog` によってエラーなくロード（consult）される。
- KB内の単純なファクト（事実）に対するクエリは成功する。
- `write/1` などを用いた単純な述語（例：`test_write/0`）の呼び出しも成功し、期待通りの出力が得られる。
- しかし、メインのクエリである `患者診断/5` を呼び出すと、この述語自体は実行を開始するものの、その内部から別のユーザー定義述語 `gadp_test/5`（元 `get_all_disease_probabilities/5`）を呼び出す段階で、`gadp_test/5` の本体コードが一行も実行されることなく失敗（サイレントフェイル）する。
- この失敗は、`gadp_test/5` の引数をアトムや数値などの非常に単純なグラウンド項に限定し、本体も `write/1` と定数値の束縛のみに簡略化しても発生する。
- `患者診断/5` 内で `gadp_test/5` を呼び出す直前の `write/1` は実行されるが、`gadp_test/5` の最初の `write/1` は実行されないことから、呼び出しのプロセス自体に問題があると推測される。

## 2. デバッグ経緯の要約

- 初期にはPrologコードの構文エラー、`pyprolog` の一部バグ (`_rename_variables`)、Prologコード内のタイポなどが修正され、KBの正常なロードが確認された。
- 問題の切り分けのため、Prologコード内の複雑な述語（ソート処理、`findall/3` を含む症状スコア計算など）が段階的に簡略化された。
- `症状マッチスコア計算` を固定値を返すようにしても問題は解決せず、`信頼度計算` へと調査範囲を移した。
- 最終的に、`患者診断/5` が `get_all_disease_probabilities/5` (テストのため `gadp_test/5` に改名) を呼び出す箇所が問題であると特定された。
- `gadp_test/5` の述語名変更、引数の簡略化（リストや変数をグラウンドなアトムや数値に変更）といった試みも、このサイレントフェイルを解消するには至らなかった。

## 3. 考えられる原因の考察

- **インタプリタの述語ディスパッチ/呼び出しメカニズムの潜在的な不具合：**
    - `患者診断/5` のような複数の引数（リスト、変数、アトム、数値が混在）を持つ述語の実行コンテキストから、さらに別のユーザー定義述語（`gadp_test/5`）を呼び出す際に、`pyprolog` の内部的な述語解決、引数渡し、または実行フレームの準備に何らかの問題が発生している。
    - 特定の引数の数（例：5引数）や、特定の引数の型の組み合わせ、あるいは呼び出し元の述語の引数の状態（一部が未束縛変数であるなど）が、この問題を引き起こすトリガーとなっている可能性がある。

- **Pythonレベルでの隠れた例外：**
    - `pyprolog` のPython実装のどこかで、この特定の呼び出しシーケンスにおいて予期せぬPython例外が発生し、それが適切に処理・報告されずにPrologレベルでの `fail` として現れている。

- **環境スタックやヒープの管理の問題（可能性は低いが否定はできない）：**
    - 特定の呼び出しシーケンスやデータ構造が、Prologの実行に必要なメモリ領域の管理に問題を引き起こし、結果として述語呼び出しが正しく完了しない。

- **アトムや述語名の内部表現とルックアップ：**
    - 述語名（特に日本語を含む場合、あるいは一定以上の長さの場合）の内部ハッシュ値や比較ロジックが、述語定義のルックアップ時に稀な衝突や失敗を引き起こしている。（ただし、述語名変更テストで改善しなかったため、この可能性は低下した）

## 4. `pyprolog` 改善のための提案

- **詳細な実行トレース機能の実装：**
    - Prolog標準の `trace/0` や `spy/1` に相当する機能、あるいはそれ以上に詳細な、述語の呼び出し(call)、終了(exit)、再試行(redo)、失敗(fail)ポートの追跡、および各ポートでの引数の状態を表示する機能。これは、このようなサイレントフェイルのデバッグに不可欠。
- **内部エラー報告の強化：**
    - Pythonレベルで発生した例外がPrologの `fail` に変換される際に、より詳細なエラー情報（Pythonのスタックトレースなど）をログやコンソールに出力するオプション。
- **述語呼び出しメカニズムのストレステスト：**
    - 様々な引数の数、型、ネストレベル、再帰呼び出しなど、複雑な述語呼び出しパターンに対するテストケースを拡充し、インタプリタの堅牢性を高める。
